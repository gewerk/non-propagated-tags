{"version":3,"file":"non-propagated-tag-select-input.js","mappings":"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","sources":["webpack:///./non-propagated-tag-select-input.js"],"sourcesContent":["/** global: Craft */\n/** global: Garnish */\n/**\n * Tag select input\n */\nCraft.NonPropagatedTagSelectInput = Craft.BaseElementSelectInput.extend(\n  {\n    searchTimeout: null,\n    searchMenu: null,\n\n    $container: null,\n    $elementsContainer: null,\n    $elements: null,\n    $addTagInput: null,\n    $spinner: null,\n\n    _ignoreBlur: false,\n\n    init: function (settings) {\n      // Normalize the settings\n      // ---------------------------------------------------------------------\n\n      // Are they still passing in a bunch of arguments?\n      if (!$.isPlainObject(settings)) {\n        // Loop through all of the old arguments and apply them to the settings\n        var normalizedSettings = {},\n          args = [\n            'id',\n            'name',\n            'tagGroupId',\n            'targetSiteId',\n            'sourceElementId',\n          ];\n\n        for (var i = 0; i < args.length; i++) {\n          if (typeof arguments[i] !== 'undefined') {\n            normalizedSettings[args[i]] = arguments[i];\n          } else {\n            break;\n          }\n        }\n\n        // eslint-disable-next-line no-param-reassign\n        settings = normalizedSettings;\n      }\n\n      this.base($.extend({}, Craft.TagSelectInput.defaults, settings));\n\n      this.$addTagInput = this.$container.children('.add').children('.text');\n      this.$spinner = this.$addTagInput.next();\n\n      this.addListener(this.$addTagInput, 'input', () => {\n        if (this.searchTimeout) {\n          clearTimeout(this.searchTimeout);\n        }\n\n        this.searchTimeout = setTimeout(this.searchForTags.bind(this), 500);\n      });\n\n      this.addListener(this.$addTagInput, 'keydown', function (ev) {\n        if (ev.keyCode === Garnish.RETURN_KEY) {\n          ev.preventDefault();\n        }\n\n        switch (ev.keyCode) {\n          case Garnish.RETURN_KEY: {\n            ev.preventDefault();\n            if (this.searchMenu) {\n              this.selectTag(this.searchMenu.$options.filter('.hover'));\n            }\n            return;\n          }\n\n          case Garnish.DOWN_KEY: {\n            ev.preventDefault();\n            if (this.searchMenu) {\n              let $hoverOption = this.searchMenu.$options.filter('.hover');\n              if ($hoverOption.length) {\n                let $nextOption = $hoverOption\n                  .parent()\n                  .nextAll()\n                  .find('a:not(.disabled)')\n                  .first();\n                if ($nextOption.length) {\n                  this.focusOption($nextOption);\n                }\n              } else {\n                this.focusOption(this.searchMenu.$options.eq(0));\n              }\n            }\n            return;\n          }\n\n          case Garnish.UP_KEY: {\n            ev.preventDefault();\n            if (this.searchMenu) {\n              let $hoverOption = this.searchMenu.$options.filter('.hover');\n              if ($hoverOption.length) {\n                let $prevOption = $hoverOption\n                  .parent()\n                  .prevAll()\n                  .find('a:not(.disabled)')\n                  .last();\n                if ($prevOption.length) {\n                  this.focusOption($prevOption);\n                }\n              } else {\n                this.focusOption(\n                  this.searchMenu.$options.eq(\n                    this.searchMenu.$options.length - 1,\n                  ),\n                );\n              }\n            }\n            return;\n          }\n        }\n      });\n\n      this.addListener(this.$addTagInput, 'focus', function () {\n        if (this.searchMenu) {\n          this.searchMenu.show();\n        }\n      });\n\n      this.addListener(this.$addTagInput, 'blur', function () {\n        if (this._ignoreBlur) {\n          this._ignoreBlur = false;\n          return;\n        }\n\n        setTimeout(() => {\n          if (this.searchMenu) {\n            this.searchMenu.hide();\n          }\n        }, 1);\n      });\n    },\n\n    focusOption: function ($option) {\n      this.searchMenu.$options.removeClass('hover');\n      $option.addClass('hover');\n      this.searchMenu.$menuList.attr(\n        'aria-activedescendant',\n        $option.attr('id'),\n      );\n    },\n\n    // No \"add\" button\n    getAddElementsBtn: $.noop,\n\n    getElementSortAxis: function () {\n      return null;\n    },\n\n    searchForTags: function () {\n      if (this.searchMenu) {\n        this.killSearchMenu();\n      }\n\n      var val = this.$addTagInput.val();\n\n      if (val) {\n        this.$spinner.removeClass('hidden');\n\n        var excludeIds = [];\n\n        for (var i = 0; i < this.$elements.length; i++) {\n          var id = $(this.$elements[i]).data('id');\n\n          if (id) {\n            excludeIds.push(id);\n          }\n        }\n\n        if (this.settings.sourceElementId) {\n          excludeIds.push(this.settings.sourceElementId);\n        }\n\n        var data = {\n          search: this.$addTagInput.val(),\n          tagGroupId: this.settings.tagGroupId,\n          siteId: this.settings.targetSiteId,\n          excludeIds: excludeIds,\n        };\n\n        Craft.postActionRequest(\n          'non-propagated-tags/input/search-for-tags',\n          data,\n          (response, textStatus) => {\n            // Just in case\n            if (this.searchMenu) {\n              this.killSearchMenu();\n            }\n\n            this.$spinner.addClass('hidden');\n\n            if (textStatus === 'success') {\n              var $menu = $('<div class=\"menu tagmenu\"/>').appendTo(\n                  Garnish.$bod,\n                ),\n                $ul = $('<ul/>').appendTo($menu);\n\n              var $li;\n\n              for (var i = 0; i < response.tags.length; i++) {\n                $li = $('<li/>').appendTo($ul);\n\n                $('<a data-icon=\"tag\"/>')\n                  .appendTo($li)\n                  .text(response.tags[i].title)\n                  .data('id', response.tags[i].id)\n                  .addClass(response.tags[i].exclude ? 'disabled' : '');\n              }\n\n              if (!response.exactMatch) {\n                $li = $('<li/>').appendTo($ul);\n                $('<a data-icon=\"plus\"/>').appendTo($li).text(data.search);\n              }\n\n              $ul.find('a:not(.disabled):first').addClass('hover');\n\n              this.searchMenu = new Garnish.Menu($menu, {\n                attachToElement: this.$addTagInput,\n                onOptionSelect: this.selectTag.bind(this),\n              });\n\n              this.addListener($menu, 'mousedown', () => {\n                this._ignoreBlur = true;\n              });\n\n              this.searchMenu.show();\n            }\n          },\n        );\n      } else {\n        this.$spinner.addClass('hidden');\n      }\n    },\n\n    selectTag: function (option) {\n      var $option = $(option);\n\n      if ($option.hasClass('disabled')) {\n        return;\n      }\n\n      var id = $option.data('id');\n      var title = $option.text();\n\n      var $element = $('<div/>', {\n        class: 'element small removable',\n        'data-id': id,\n        'data-site-id': this.settings.targetSiteId,\n        'data-label': title,\n        'data-editable': '1',\n      }).appendTo(this.$elementsContainer);\n\n      var $input = $('<input/>', {\n        type: 'hidden',\n        name: this.settings.name + '[]',\n        value: id,\n      }).appendTo($element);\n\n      $('<a/>', {\n        class: 'delete icon',\n        title: Craft.t('app', 'Remove'),\n      }).appendTo($element);\n\n      var $titleContainer = $('<div/>', {\n        class: 'label',\n      }).appendTo($element);\n\n      $('<span/>', {\n        class: 'title',\n        text: title,\n      }).appendTo($titleContainer);\n\n      var margin = -($element.outerWidth() + 10);\n      this.$addTagInput.css('margin-' + Craft.left, margin + 'px');\n\n      var animateCss = {};\n      animateCss['margin-' + Craft.left] = 0;\n      this.$addTagInput.velocity(animateCss, 'fast');\n\n      this.$elements = this.$elements.add($element);\n\n      this.addElements($element);\n\n      this.killSearchMenu();\n      this.$addTagInput.val('');\n      this.$addTagInput.trigger('focus');\n\n      if (!id) {\n        // We need to create the tag first\n        $element.addClass('loading disabled');\n\n        var data = {\n          groupId: this.settings.tagGroupId,\n          siteId: this.settings.targetSiteId,\n          title: title,\n        };\n\n        Craft.postActionRequest(\n          'non-propagated-tags/input/create-tag',\n          data,\n          (response, textStatus) => {\n            if (textStatus === 'success' && response.success) {\n              $element.attr('data-id', response.id);\n              $input.val(response.id);\n\n              $element.removeClass('loading disabled');\n            } else {\n              this.removeElement($element);\n\n              if (textStatus === 'success') {\n                // Some sort of validation error that still resulted in  a 200 response. Shouldn't be possible though.\n                Craft.cp.displayError(\n                  Craft.t('app', 'A server error occurred.'),\n                );\n              }\n            }\n          },\n        );\n      }\n    },\n\n    killSearchMenu: function () {\n      this.searchMenu.hide();\n      this.searchMenu.destroy();\n      this.searchMenu = null;\n    },\n  },\n  {\n    defaults: {\n      tagGroupId: null,\n      siteId: null,\n    },\n  },\n);\n"],"names":["Craft","NonPropagatedTagSelectInput","BaseElementSelectInput","extend","searchTimeout","searchMenu","$container","$elementsContainer","$elements","$addTagInput","$spinner","_ignoreBlur","init","settings","$","isPlainObject","normalizedSettings","args","i","length","arguments","this","base","TagSelectInput","defaults","children","next","addListener","clearTimeout","setTimeout","searchForTags","bind","ev","keyCode","Garnish","RETURN_KEY","preventDefault","selectTag","$options","filter","DOWN_KEY","$hoverOption","$nextOption","parent","nextAll","find","first","focusOption","eq","UP_KEY","$prevOption","prevAll","last","show","hide","$option","removeClass","addClass","$menuList","attr","getAddElementsBtn","noop","getElementSortAxis","killSearchMenu","val","excludeIds","id","data","push","sourceElementId","search","tagGroupId","siteId","targetSiteId","postActionRequest","response","textStatus","$li","$menu","appendTo","$bod","$ul","tags","text","title","exclude","exactMatch","Menu","attachToElement","onOptionSelect","option","hasClass","$element","class","$input","type","name","value","t","$titleContainer","margin","outerWidth","css","left","animateCss","velocity","add","addElements","trigger","groupId","success","removeElement","cp","displayError","destroy"],"sourceRoot":""}
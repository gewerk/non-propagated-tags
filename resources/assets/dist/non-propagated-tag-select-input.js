Craft.NonPropagatedTagSelectInput=Craft.BaseElementSelectInput.extend({searchTimeout:null,searchMenu:null,$container:null,$elementsContainer:null,$elements:null,$addTagInput:null,$spinner:null,_ignoreBlur:!1,init:function(e){if(!$.isPlainObject(e)){for(var t={},s=["id","name","tagGroupId","siteId","sourceElementId"],a=0;a<s.length&&void 0!==arguments[a];a++)t[s[a]]=arguments[a];e=t}this.base($.extend({},Craft.TagSelectInput.defaults,e)),this.$addTagInput=this.$container.children(".add").children(".text"),this.$spinner=this.$addTagInput.next(),this.addListener(this.$addTagInput,"input",(()=>{this.searchTimeout&&clearTimeout(this.searchTimeout),this.searchTimeout=setTimeout(this.searchForTags.bind(this),500)})),this.addListener(this.$addTagInput,"keydown",(function(e){switch(e.keyCode===Garnish.RETURN_KEY&&e.preventDefault(),e.keyCode){case Garnish.RETURN_KEY:return e.preventDefault(),void(this.searchMenu&&this.selectTag(this.searchMenu.$options.filter(".hover")));case Garnish.DOWN_KEY:if(e.preventDefault(),this.searchMenu){let e=this.searchMenu.$options.filter(".hover");if(e.length){let t=e.parent().nextAll().find("a:not(.disabled)").first();t.length&&this.focusOption(t)}else this.focusOption(this.searchMenu.$options.eq(0))}return;case Garnish.UP_KEY:if(e.preventDefault(),this.searchMenu){let e=this.searchMenu.$options.filter(".hover");if(e.length){let t=e.parent().prevAll().find("a:not(.disabled)").last();t.length&&this.focusOption(t)}else this.focusOption(this.searchMenu.$options.eq(this.searchMenu.$options.length-1))}return}})),this.addListener(this.$addTagInput,"focus",(function(){this.searchMenu&&this.searchMenu.show()})),this.addListener(this.$addTagInput,"blur",(function(){this._ignoreBlur?this._ignoreBlur=!1:setTimeout((()=>{this.searchMenu&&this.searchMenu.hide()}),1)}))},focusOption:function(e){this.searchMenu.$options.removeClass("hover"),e.addClass("hover"),this.searchMenu.$menuList.attr("aria-activedescendant",e.attr("id"))},getAddElementsBtn:$.noop,getElementSortAxis:function(){return null},searchForTags:function(){if(this.searchMenu&&this.killSearchMenu(),this.$addTagInput.val()){this.$spinner.removeClass("hidden");for(var e=[],t=0;t<this.$elements.length;t++){var s=$(this.$elements[t]).data("id");s&&e.push(s)}this.settings.sourceElementId&&!this.settings.allowSelfRelations&&e.push(this.settings.sourceElementId);var a={search:this.$addTagInput.val(),tagGroupId:this.settings.tagGroupId,siteId:this.settings.siteId,excludeIds:e};Craft.sendActionRequest("POST","non-propagated-tags/input/search-for-tags",{data:a}).then((e=>{this.searchMenu&&this.killSearchMenu(),this.$spinner.addClass("hidden");for(var t,s=$('<div class="menu tagmenu"/>').appendTo(Garnish.$bod),i=$("<ul/>").appendTo(s),n=0;n<e.data.tags.length;n++)t=$("<li/>").appendTo(i),$('<a data-icon="tag"/>').appendTo(t).text(e.data.tags[n].title).data("id",e.data.tags[n].id).addClass(e.data.tags[n].exclude?"disabled":"");e.data.exactMatch||(t=$("<li/>").appendTo(i),$('<a data-icon="plus"/>').appendTo(t).text(a.search)),i.find("a:not(.disabled):first").addClass("hover"),this.searchMenu=new Garnish.Menu(s,{attachToElement:this.$addTagInput,onOptionSelect:this.selectTag.bind(this)}),this.addListener(s,"mousedown",(()=>{this._ignoreBlur=!0})),this.searchMenu.show()})).catch((()=>{this.searchMenu&&this.killSearchMenu(),this.$spinner.addClass("hidden")}))}else this.$spinner.addClass("hidden")},selectTag:function(e){var t=$(e);if(!t.hasClass("disabled")){var s=t.data("id"),a=t.text(),i=$("<div/>",{class:"element small removable","data-id":s,"data-site-id":this.settings.siteId,"data-label":a,"data-editable":"1"}).appendTo(this.$elementsContainer),n=$("<input/>",{type:"hidden",name:this.settings.name+"[]",value:s}).appendTo(i);$("<button/>",{class:"delete icon",title:Craft.t("app","Remove"),type:"button","aria-label":Craft.t("app","Remove {label}",{label:a})}).appendTo(i);var d=$("<div/>",{class:"label"}).appendTo(i);if($("<span/>",{class:"title",text:a}).appendTo(d),this.$elements=this.$elements.add(i),this.addElements(i),this.killSearchMenu(),this.$addTagInput.val(""),this.$addTagInput.trigger("focus"),!s){i.addClass("loading disabled");var h={groupId:this.settings.tagGroupId,siteId:this.settings.siteId,title:a};Craft.sendActionRequest("POST","non-propagated-tags/input/create-tag",{data:h}).then((e=>{i.attr("data-id",e.data.id),n.val(e.data.id),i.removeClass("loading disabled")})).catch((()=>{this.removeElement(i),Craft.cp.displayError(Craft.t("app","A server error occurred."))}))}}},killSearchMenu:function(){this.searchMenu.hide(),this.searchMenu.destroy(),this.searchMenu=null}},{defaults:{tagGroupId:null,siteId:null}});
//# sourceMappingURL=non-propagated-tag-select-input.js.map